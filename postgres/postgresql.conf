# PostgreSQL Configuration for JunosCommander Production Environment
# Optimized for network device inventory management (1000+ devices)
# Version: PostgreSQL 15+

#------------------------------------------------------------------------------
# CONNECTION SETTINGS
#------------------------------------------------------------------------------
listen_addresses = '*'
port = 5432
max_connections = 200                   # Reserved for PgBouncer pooling
superuser_reserved_connections = 3

#------------------------------------------------------------------------------
# MEMORY SETTINGS
#------------------------------------------------------------------------------
# Optimized for read-heavy network device inventory workload
shared_buffers = 256MB                  # 25% of RAM (assuming 1GB container)
effective_cache_size = 512MB            # OS + PostgreSQL cache estimate
work_mem = 4MB                          # Per-operation memory
maintenance_work_mem = 64MB             # For VACUUM, CREATE INDEX, etc.
max_wal_size = 1GB                      # WAL size limit
min_wal_size = 80MB                     # Minimum WAL size

#------------------------------------------------------------------------------
# QUERY TUNING
#------------------------------------------------------------------------------
# Optimized for device inventory and command result queries
random_page_cost = 1.1                  # SSD storage assumption
effective_io_concurrency = 200          # SSD concurrent I/O
seq_page_cost = 1.0                     # Sequential page cost

# Join and sort optimizations
enable_hashjoin = on
enable_mergejoin = on
enable_nestloop = on
enable_sort = on

#------------------------------------------------------------------------------
# WRITE AHEAD LOG (WAL) SETTINGS
#------------------------------------------------------------------------------
# Configured for replication readiness
wal_level = replica                     # Enable replication
wal_log_hints = on                      # Required for pg_rewind
max_wal_senders = 3                     # Number of replication connections
wal_keep_size = 128MB                   # Keep WAL segments for replication
hot_standby = on                        # Allow read queries on standby
hot_standby_feedback = on               # Prevent query conflicts

# WAL archiving for point-in-time recovery
archive_mode = on
archive_command = 'cp %p /var/lib/postgresql/wal_archive/%f'

#------------------------------------------------------------------------------
# REPLICATION SETTINGS
#------------------------------------------------------------------------------
# Asynchronous streaming replication
max_replication_slots = 3
synchronous_standby_names = ''          # Async replication (change for sync)
wal_receiver_timeout = 60s
wal_sender_timeout = 60s

#------------------------------------------------------------------------------
# CHECKPOINT SETTINGS
#------------------------------------------------------------------------------
# Optimized for steady-state operation
checkpoint_timeout = 5min              # Checkpoint every 5 minutes
checkpoint_completion_target = 0.9      # Spread checkpoint I/O
checkpoint_warning = 30s                # Warn if checkpoints are too frequent

#------------------------------------------------------------------------------
# LOGGING SETTINGS
#------------------------------------------------------------------------------
# Comprehensive logging for production monitoring
logging_collector = on
log_destination = 'stderr,csvlog'
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_file_mode = 0640
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = on

# What to log
log_min_messages = warning
log_min_error_statement = error
log_min_duration_statement = 1000      # Log slow queries (>1s)
log_connections = on
log_disconnections = on
log_hostname = on
log_line_prefix = '%m [%p] %q%u@%d '

# Performance logging
log_lock_waits = on                     # Log lock waits
log_temp_files = 10240                  # Log temp files >10MB
log_autovacuum_min_duration = 0         # Log all autovacuum activity

#------------------------------------------------------------------------------
# AUTOVACUUM SETTINGS
#------------------------------------------------------------------------------
# Optimized for device inventory with frequent updates
autovacuum = on
log_autovacuum_min_duration = 0
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.2
autovacuum_analyze_scale_factor = 0.1
autovacuum_freeze_max_age = 200000000
autovacuum_multixact_freeze_max_age = 400000000
autovacuum_vacuum_cost_delay = 20ms
autovacuum_vacuum_cost_limit = 200

#------------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
#------------------------------------------------------------------------------
# Security and compatibility settings
ssl = on
ssl_cert_file = '/etc/ssl/certs/server.crt'
ssl_key_file = '/etc/ssl/private/server.key'
ssl_ca_file = '/etc/ssl/certs/ca.crt'
ssl_ciphers = 'HIGH:MEDIUM:+3DES:!aNULL'

# Timezone and locale
timezone = 'UTC'
datestyle = 'iso, mdy'
default_text_search_config = 'pg_catalog.english'

#------------------------------------------------------------------------------
# STATISTICS SETTINGS
#------------------------------------------------------------------------------
# Enhanced statistics for query optimization
track_activities = on
track_counts = on
track_io_timing = on
track_functions = pl                    # Track PL functions
stats_temp_directory = '/var/run/postgresql/stats_temp'

# Statement statistics extension
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.max = 10000
pg_stat_statements.track = all

#------------------------------------------------------------------------------
# NETWORK DEVICE SPECIFIC OPTIMIZATIONS
#------------------------------------------------------------------------------
# Optimized for JunosCommander workload patterns

# Connection pooling preparation
idle_in_transaction_session_timeout = 60000  # 60 seconds
statement_timeout = 300000                    # 5 minutes for long operations
lock_timeout = 30000                          # 30 seconds for locks

# Large result sets for device inventory
cursor_tuple_fraction = 0.1

# Parallel query settings for large device scans
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_parallel_maintenance_workers = 2

#------------------------------------------------------------------------------
# PERFORMANCE MONITORING
#------------------------------------------------------------------------------
# Enable performance monitoring extensions
log_parser_stats = off
log_planner_stats = off
log_executor_stats = off
log_statement_stats = off

# Query performance insights
compute_query_id = on
log_parameter_max_length = 1024
log_parameter_max_length_on_error = 1024

#------------------------------------------------------------------------------
# BACKUP AND RECOVERY
#------------------------------------------------------------------------------
# Settings to support backup strategies
full_page_writes = on
wal_compression = on
wal_init_zero = on
wal_recycle = on

# Recovery settings
recovery_min_apply_delay = 0
recovery_target_timeline = 'latest'

#------------------------------------------------------------------------------
# EXTENSIONS AND MODULES
#------------------------------------------------------------------------------
# Useful extensions for network device management
# Note: Enable these in init.sql
# - pg_stat_statements (query performance)
# - pg_trgm (fuzzy text search for device names)
# - uuid-ossp (UUID generation)
# - citext (case-insensitive text)